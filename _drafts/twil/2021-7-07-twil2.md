---
title: "This Week I Learned 2: Python, SQL recaps"
classes: wide
categories:
  - TWIL
tags:
  - python
  - sql
---
As I continue to work as a Data Science intern, here are some of the most useful things I've learnt about.

## Python
### 1. df.apply() on multiple columns
Usually, the apply function is used on a single column on a dataframe (df). Here's how to apply a function on multiple columns.
*Problem: I have 2 columns, 'score_a' and 'score_b'. Both of these columns could be None or floats. I want to have a 'final_score' which gets the average of both scores (if there are values for both).*

1. Create a function that applies to rows on a column
We can always do anonymous lambda functions, but doing this makes it a lot more clearer and neater.
```python
def calc_final_score(row):
  score_a = row['score_a']
  score_b = row['score_b']
  if (score_a == None) and (score_b == None):
    return None
  elif (score_a == None) and (score_b != None):
    return score_a
  elif (score_a != None) and (score_b == None):
    return score_b
  else:
    return (score_a + score_b) / 2
```

2. Use the apply on the **entire dataframe**!
```python
# adds the new final score column!
df['final_score'] = df.apply(lambda row: calc_final_score(row))
```

## SQL
### 1. COALESCE()
A neat little function that finds the first non-null value in a list. This is useful when you have a default value you can use if the query only has null values
```sql
SELECT COALESCE(NULL, NULL, NULL, 'first non null val', NULL, 'Example.com');

-- return 'first non null val'
```

### 2. UPSERT: Update or Insert
Never knew there was a name for this very common thing where you need to Update a value if its present otherwise Insert it into the table! Although some sql languages have an upsert() function, Azure SQL does not. Fortunately, I have found someone with a workaround.
*Problem: You have a table called `tags` which has columns `post_id` and `tag`. How do you upsert values into this table?*
```sql
-- the tags table
create table [dbo].[tags] ( 
    [post_id] int not null, 
    [tag] nvarchar(50) not null, 
    constraint pk__tags primary key clustered ([post_id], [tag]) 
)
```
The upsert function:
```sql
insert into [dbo].[tags] ([post_id], [tag]) 
select * from ( 
    values (10, 'tag123') -- sample value 
) as s([post_id], [tag]) 
where not exists ( 
    select * from [dbo].[tags] t with (updlock) 
    where s.[post_id] = t.[post_id] and s.[tag] = t.[tag] 
)
```
What this function does is:
1. create a temp table s
2. If the row exists:
  update the values
3. else:
  insert the values from the temp table

[Resource](https://devblogs.microsoft.com/azure-sql/the-insert-if-not-exists-challenge-a-solution/)
